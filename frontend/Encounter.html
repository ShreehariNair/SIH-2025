<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AYUSH Dual Coding - Patient Encounters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "green-primary": "#059669",
              "green-secondary": "#10b981",
              "green-light": "#d1fae5",
              "green-dark": "#047857",
            },
          },
        },
      };
    </script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }

      .gradient-bg {
        background: linear-gradient(
          135deg,
          #059669 0%,
          #10b981 50%,
          #34d399 100%
        );
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .slide-in {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(-20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .loading-spinner {
        border: 3px solid #d1fae5;
        border-top: 3px solid #10b981;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .pulse-green {
        animation: pulseGreen 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulseGreen {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .badge-namaste {
        background: linear-gradient(135deg, #059669, #10b981);
      }

      .badge-icd11 {
        background: linear-gradient(135deg, #047857, #059669);
      }

      .timeline-item::before {
        content: "";
        position: absolute;
        left: -6px;
        top: 0;
        width: 12px;
        height: 12px;
        background: #10b981;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #d1fae5;
      }

      .timeline-line {
        position: absolute;
        left: -1px;
        top: 12px;
        bottom: -12px;
        width: 2px;
        background: #d1fae5;
      }

      .alert-box {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <header
      class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm"
    >
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <div class="text-primary size-8">
              <svg
                fill="none"
                viewBox="0 0 48 48"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M44 11.2727C44 14.0109 39.8386 16.3957 33.69 17.6364C39.8386 18.877 44 21.2618 44 24C44 26.7382 39.8386 29.123 33.69 30.3636C39.8386 31.6043 44 33.9891 44 36.7273C44 40.7439 35.0457 44 24 44C12.9543 44 4 40.7439 4 36.7273C4 33.9891 8.16144 31.6043 14.31 30.3636C8.16144 29.123 4 26.7382 4 24C4 21.2618 8.16144 18.877 14.31 17.6364C8.16144 16.3957 4 14.0109 4 11.2727C4 7.25611 12.9543 4 24 4C35.0457 4 44 7.25611 44 11.2727Z"
                  fill="#39e079"
                ></path>
              </svg>
            </div>
            <h2 class="text-lg font-bold text-slate-900 dark:text-white">
              AYUSH
            </h2>
          </div>
          <nav class="hidden md:flex items-center gap-8">
            <a
              class="text-sm font-medium hover:text-primary transition-colors"
              href="index.html"
              >Home</a
            >
            <a
              class="text-sm font-medium hover:text-primary transition-colors"
              href="search-codes.html"
              >Search Codes</a
            >
            <a
              class="text-sm font-medium hover:text-primary transition-colors"
              href="search.html"
              >Search Diseases</a
            >
            <a
              class="text-sm font-medium hover:text-primary transition-colors"
              href="encounter.html"
              >Add Encounter</a
            >
            <a
              class="text-sm font-medium hover:text-primary transition-colors"
              href="about.html"
              >About</a
            >
          </nav>
          <div class="flex items-center gap-4">
            <div
              class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"
              style="background-image: url('')"
            ></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Header Section -->
    <div class="gradient-bg py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <div class="text-6xl mb-4">📋</div>
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
          Patient Encounters
        </h1>
        <p class="text-xl text-green-100 max-w-2xl mx-auto">
          Manage patient diagnoses, medical records, and healthcare encounters
          with dual coding system
        </p>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Patient Search Section -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 card-hover">
        <div class="text-center mb-8">
          <h2 class="text-2xl font-bold text-gray-800 mb-2">
            Patient Information
          </h2>
          <p class="text-gray-600">
            Search for existing patients or create new encounters
          </p>
        </div>

        <div class="flex flex-col md:flex-row gap-4 max-w-4xl mx-auto">
          <div class="flex-1 relative">
            <div
              class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
            </div>
            <input
              type="text"
              id="patientIdInput"
              placeholder="Enter Patient ID (e.g., P001, P002, P003)..."
              class="w-full pl-12 pr-4 py-4 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:ring-0 text-lg transition-all duration-200"
            />
            <div
              id="patientSuggestions"
              class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg mt-1 shadow-lg hidden z-10"
            ></div>
          </div>
          <button
            onclick="fetchPatientData()"
            class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl"
          >
            <span class="flex items-center justify-center space-x-2">
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                ></path>
              </svg>
              <span>Fetch Patient</span>
            </span>
          </button>
        </div>

        <!-- Quick Patient Access -->
        <div class="mt-6 text-center">
          <p class="text-sm text-gray-500 mb-3">
            Quick access to recent patients:
          </p>
          <div class="flex flex-wrap justify-center gap-2">
            <button
              onclick="quickPatientSearch('P001')"
              class="px-4 py-2 bg-green-100 text-green-700 rounded-full text-sm hover:bg-green-200 transition-colors duration-200"
            >
              Patient P001
            </button>
            <button
              onclick="quickPatientSearch('P002')"
              class="px-4 py-2 bg-green-100 text-green-700 rounded-full text-sm hover:bg-green-200 transition-colors duration-200"
            >
              Patient P002
            </button>
            <button
              onclick="quickPatientSearch('P003')"
              class="px-4 py-2 bg-green-100 text-green-700 rounded-full text-sm hover:bg-green-200 transition-colors duration-200"
            >
              Patient P003
            </button>
            <button
              onclick="showCreatePatientModal()"
              class="px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200 transition-colors duration-200"
            >
              + New Patient
            </button>
          </div>
        </div>
      </div>
      <div
        id="newPatientModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden transition-opacity duration-300"
      >
        <div
          class="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full transform scale-95 transition-transform duration-300"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">New Patient</h2>
            <button
              onclick="closeModal()"
              class="text-gray-400 hover:text-gray-600 transition-colors"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
          <form id="newPatientForm" class="space-y-4">
            <div class="flex flex-col">
              <label
                for="newPatientId"
                class="text-sm font-medium text-gray-700"
                >Patient ID <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="newPatientId"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                placeholder="Enter patient ID"
              />
            </div>
            <div class="flex flex-col">
              <label
                for="newPatientName"
                class="text-sm font-medium text-gray-700"
                >Patient Name <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="newPatientName"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
                placeholder="Enter patient name"
              />
            </div>
            <div class="flex flex-col">
              <label
                for="newPatientDob"
                class="text-sm font-medium text-gray-700"
                >Date of Birth</label
              >
              <input
                type="date"
                id="newPatientDob"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
              />
            </div>
            <div class="flex flex-col">
              <label
                for="newPatientGender"
                class="text-sm font-medium text-gray-700"
                >Gender</label
              >
              <select
                id="newPatientGender"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
              >
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <button
              type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105"
            >
              Create Patient
            </button>
          </form>
        </div>
      </div>
      <!-- Patient Information Display -->
      <div id="patientInfoSection" class="hidden mb-8">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden card-hover">
          <div class="bg-gradient-to-r from-green-600 to-green-500 p-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <div
                  class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-2xl"
                >
                  👤
                </div>
                <div>
                  <h3 class="text-2xl font-bold text-white" id="patientName">
                    Patient Name
                  </h3>
                  <p class="text-green-100" id="patientDetails">
                    Patient Details
                  </p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-white text-sm opacity-75">Patient ID</div>
                <div class="text-white text-xl font-bold" id="displayPatientId">
                  -
                </div>
              </div>
            </div>
          </div>
          <div class="p-6">
            <div class="grid md:grid-cols-3 gap-6">
              <div class="text-center">
                <div
                  class="text-2xl font-bold text-green-600"
                  id="totalEncounters"
                >
                  0
                </div>
                <div class="text-gray-600 text-sm">Total Encounters</div>
              </div>
              <div class="text-center">
                <div
                  class="text-2xl font-bold text-green-600"
                  id="activeDiagnoses"
                >
                  0
                </div>
                <div class="text-gray-600 text-sm">Active Diagnoses</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-green-600" id="lastVisit">
                  -
                </div>
                <div class="text-gray-600 text-sm">Last Visit</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Encounter Section -->
      <div class="grid lg:grid-cols-2 gap-8 mb-8">
        <!-- Add New Diagnosis -->
        <div class="bg-white rounded-2xl shadow-xl p-6 card-hover">
          <div class="flex items-center space-x-3 mb-6">
            <div
              class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-green-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                ></path>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Add New Diagnosis</h3>
          </div>

          <form id="diagnosisForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >NAMASTE Code</label
              >
              <select
                id="namasteCodeSelect"
                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:ring-0 transition-all duration-200"
              >
                <option value="">Select NAMASTE Code</option>
                <option value="AYU001|Fever (Jwara)">
                  AYU001 - Fever (Jwara)
                </option>
                <option value="AYU002|Headache (Shiroroga)">
                  AYU002 - Headache (Shiroroga)
                </option>
                <option value="YOG001|Stress Management">
                  YOG001 - Stress Management
                </option>
                <option value="UNA001|Cold (Nazla)">
                  UNA001 - Cold (Nazla)
                </option>
                <option value="HOM001|Anxiety (Chinta)">
                  HOM001 - Anxiety (Chinta)
                </option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >ICD-11 Code</label
              >
              <select
                id="icd11CodeSelect"
                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:ring-0 transition-all duration-200"
              >
                <option value="">Select ICD-11 Code</option>
                <option value="MG50|Fever, unspecified">
                  MG50 - Fever, unspecified
                </option>
                <option value="MB40.0|Tension-type headache">
                  MB40.0 - Tension-type headache
                </option>
                <option value="QE10|Stress-related disorders">
                  QE10 - Stress-related disorders
                </option>
                <option value="CA40|Acute upper respiratory infections">
                  CA40 - Acute upper respiratory infections
                </option>
                <option value="QA40|Anxiety disorders">
                  QA40 - Anxiety disorders
                </option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Clinical Notes</label
              >
              <textarea
                id="clinicalNotes"
                rows="3"
                placeholder="Enter clinical observations and notes..."
                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:ring-0 transition-all duration-200"
              ></textarea>
            </div>

            <button
              type="button"
              onclick="addDiagnosis()"
              class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105"
            >
              Add Diagnosis
            </button>
          </form>
        </div>

        <!-- Current Session Summary -->
        <div class="bg-white rounded-2xl shadow-xl p-6 card-hover">
          <div class="flex items-center space-x-3 mb-6">
            <div
              class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-blue-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Current Session</h3>
          </div>

          <div id="currentSessionContent" class="space-y-4">
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-4">📋</div>
              <p>No diagnoses added yet</p>
              <p class="text-sm mt-2">
                Add diagnoses to start building the encounter
              </p>
            </div>
          </div>

          <div id="sessionActions" class="hidden mt-6 space-y-3">
            <button
              onclick="saveEncounter()"
              class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-all duration-200"
            >
              💾 Save Encounter
            </button>
            <button
              onclick="clearSession()"
              class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold transition-all duration-200"
            >
              🗑️ Clear Session
            </button>
          </div>
        </div>
      </div>
      <div id="patientInfo" class="my-4"></div>
      <!-- Patient History Section -->
      <div id="patientHistorySection" class="hidden">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden card-hover">
          <div class="bg-gradient-to-r from-green-700 to-green-600 p-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="text-3xl">📊</div>
                <div>
                  <h3 class="text-2xl font-bold text-white">Medical History</h3>
                  <p class="text-green-100">
                    Complete patient encounter timeline
                  </p>
                </div>
              </div>
              <button
                onclick="exportPatientData()"
                class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition-all duration-200"
              >
                📄 Export
              </button>
            </div>
          </div>
          <div class="p-6">
            <div id="patientHistoryContent">
              <!-- History content will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-300">
      <div
        class="max-w-7xl mx-auto px-6 py-10 grid grid-cols-1 md:grid-cols-3 gap-8"
      >
        <!-- Column 1 -->
        <div>
          <h3 class="flex items-center gap-2 text-white font-semibold text-lg">
            <i class="fa-solid fa-heart-pulse"></i> AYUSH Dual Coding
          </h3>
          <p class="mt-2 text-sm">
            Professional medical coding platform for healthcare integration
          </p>
          <div class="mt-3 flex space-x-4 text-sm">
            <a href="#" class="hover:text-white">Privacy Policy</a>
            <a href="#" class="hover:text-white">Terms of Service</a>
          </div>
        </div>
        <!-- Column 2 -->
        <div>
          <h3 class="flex items-center gap-2 text-white font-semibold text-lg">
            <i class="fa-solid fa-link"></i> Navigation
          </h3>
          <ul class="mt-2 space-y-2 text-sm">
            <li>
              <a
                href="index.html"
                class="flex items-center gap-2 hover:text-white"
                ><i class="fa-solid fa-home"></i>Home</a
              >
            </li>
            <li>
              <a
                href="search-codes.html"
                class="flex items-center gap-2 hover:text-white"
                ><i class="fa-solid fa-magnifying-glass"></i>Search Codes</a
              >
            </li>
            <li>
              <a
                href="search.html"
                class="flex items-center gap-2 hover:text-white"
                ><i class="fa-solid fa-magnifying-glass"></i>Search Diseases</a
              >
            </li>
            <li>
              <a
                href="encounter.html"
                class="flex items-center gap-2 hover:text-white"
                ><i class="fa-regular fa-file-lines"></i>Add Encounter</a
              >
            </li>
            <li>
              <a
                href="about.html"
                class="flex items-center gap-2 hover:text-white"
                ><i class="fa-solid fa-circle-info"></i>About</a
              >
            </li>
          </ul>
        </div>
        <!-- Column 3 -->
        <div>
          <h3 class="flex items-center gap-2 text-white font-semibold text-lg">
            <i class="fa-solid fa-award"></i> SIH 2025
          </h3>
          <ul class="mt-2 space-y-2 text-sm">
            <li>Smart India Hackathon 2025</li>
            <li>Team Elite ES6</li>
            <li>Ministry of AYUSH</li>
          </ul>
        </div>
      </div>
      <!-- Bottom copyright -->
      <div class="border-t border-gray-600 text-center py-4 text-sm">
        © 2025 AYUSH Dual Coding System. All rights reserved.
      </div>
    </footer>

    <script>
      let currentPatient = null;
      let currentSession = [];

      // Fetches patient data from the backend based on Patient ID
      async function fetchPatientData() {
        const patientId = document
          .getElementById("patientIdInput")
          .value.trim()
          .toUpperCase();
        if (!patientId) {
          showAlert("Please enter a Patient ID", "warning");
          return;
        }

        try {
          const res = await fetch(
            `http://localhost:5000/api/v1/encounters/${patientId}`
          );
          if (!res.ok) {
            if (res.status === 404) {
              showAlert(
                `Patient ID ${patientId} not found. You can create a new record by adding their details and saving.`,
                "info"
              );
              // Clear patient info fields for new patient
              document.getElementById("patientNameInput").value = "";
              document.getElementById("patientDobInput").value = "";
              document.getElementById("patientGenderInput").value = "";
              currentPatient = null;
              return;
            }
            throw new Error("Failed to fetch patient data.");
          }
          const data = await res.json();
          currentPatient = data;
          displayPatientInfo(currentPatient);
          displayPatientHistory(currentPatient);
          document
            .getElementById("patientInfoSection")
            .classList.remove("hidden");
          document
            .getElementById("patientHistorySection")
            .classList.remove("hidden");
          showAlert(
            `Patient ${currentPatient.name} loaded successfully!`,
            "success"
          );
        } catch (err) {
          showAlert(err.message, "error");
          console.error("Fetch patient data error:", err);
        }
      }

      function quickPatientSearch(patientId) {
        document.getElementById("patientIdInput").value = patientId;
        fetchPatientData();
      }

      // Adds a diagnosis to the current session
      function addDiagnosis() {
        const namasteSelect = document.getElementById("namasteCodeSelect");
        const icd11Select = document.getElementById("icd11CodeSelect");
        const clinicalNotes = document
          .getElementById("clinicalNotes")
          .value.trim();

        const namasteCode = namasteSelect.value.split("|")[0];
        const namasteDisplay = namasteSelect.value.split("|")[1];
        const icd11Code = icd11Select.value.split("|")[0];
        const icd11Display = icd11Select.value.split("|")[1];

        if (!namasteCode || !icd11Code) {
          showAlert("Please select both NAMASTE and ICD-11 codes", "warning");
          return;
        }

        const newDiagnosis = {
          namaste: { code: namasteCode, display: namasteDisplay },
          icd11: { code: icd11Code, display: icd11Display },
          notes: clinicalNotes,
          recordedAt: new Date().toISOString(),
        };

        currentSession.push(newDiagnosis);
        updateCurrentSession();

        // Reset the form fields after adding
        namasteSelect.value = "";
        icd11Select.value = "";
        document.getElementById("clinicalNotes").value = "";
        showAlert("Diagnosis added to current session!", "success");
      }

      // Updates the current session display section
      function updateCurrentSession() {
        const sessionContent = document.getElementById("currentSessionContent");
        sessionContent.innerHTML = "";
        const sessionActions = document.getElementById("sessionActions");

        if (currentSession.length === 0) {
          sessionContent.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-4">📋</div>
              <p>No diagnoses added yet</p>
              <p class="text-sm mt-2">Add diagnoses to start building the encounter</p>
            </div>
          `;
          sessionActions.classList.add("hidden");
        } else {
          const listHtml = currentSession
            .map(
              (diag, index) => `
            <div class="p-4 bg-gray-100 rounded-lg flex items-start space-x-4 slide-in">
              <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                  <span class="px-3 py-1 text-xs font-semibold rounded-full badge-namaste text-white">${
                    diag.namaste.code
                  }</span>
                  <span class="px-3 py-1 text-xs font-semibold rounded-full badge-icd11 text-white">${
                    diag.icd11.code
                  }</span>
                </div>
                <p class="text-gray-800 font-medium">${
                  diag.namaste.display
                } / ${diag.icd11.display}</p>
                ${
                  diag.notes
                    ? `<p class="text-sm text-gray-600 mt-1">Notes: ${diag.notes}</p>`
                    : ""
                }
              </div>
              <button onclick="removeDiagnosis(${index})" class="text-red-500 hover:text-red-700 transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          `
            )
            .join("");

          sessionContent.innerHTML = listHtml;
          sessionActions.classList.remove("hidden");
        }
      }

      function removeDiagnosis(index) {
        currentSession.splice(index, 1);
        updateCurrentSession();
        showAlert("Diagnosis removed from session", "info");
      }

      async function saveEncounter() {
        if (!currentPatient) {
          const patientId = document
            .getElementById("patientIdInput")
            .value.trim();
          const patientName = document
            .getElementById("patientNameInput")
            ?.value.trim();
          const patientDob = document.getElementById("patientDobInput")?.value;
          const patientGender =
            document.getElementById("patientGenderInput")?.value;

          if (!patientId || !patientName) {
            showAlert(
              "Please enter Patient ID and Name to create a new record",
              "warning"
            );
            return;
          }

          currentPatient = {
            patientId: patientId,
            name: patientName,
            dob: patientDob,
            gender: patientGender,
          };
        }

        if (currentSession.length === 0) {
          showAlert("Please add at least one diagnosis to save", "warning");
          return;
        }

        const payload = {
          patientId: currentPatient.patientId,
          patientName: currentPatient.name,
          patientDob: currentPatient.dob,
          patientGender: currentPatient.gender,
          diagnoses: currentSession,
        };

        try {
          const res = await fetch(
            "http://localhost:5000/api/v1/encounters/upload",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );

          if (!res.ok) throw new Error("Failed to save encounter");

          const updatedPatient = await res.json();
          currentPatient = updatedPatient;
          currentSession = [];

          updateCurrentSession();
          displayPatientInfo(currentPatient);
          displayPatientHistory(currentPatient);

          showAlert("Encounter saved to database!", "success");
        } catch (err) {
          showAlert("Error saving encounter: " + err.message, "error");
          console.error("Save encounter error:", err);
        }
      }

      // Display patient info in the header section
      function displayPatientInfo(patient) {
        document.getElementById("patientName").textContent = patient.name;
        document.getElementById("displayPatientId").textContent =
          patient.patientId;
        document.getElementById(
          "patientDetails"
        ).textContent = `DOB: ${new Date(
          patient.dob
        ).toLocaleDateString()} | Gender: ${patient.gender}`;
        document.getElementById("totalEncounters").textContent =
          patient.encounters.length;
        document.getElementById("activeDiagnoses").textContent =
          patient.activeDiagnoses;
        document.getElementById("lastVisit").textContent = patient.lastVisit
          ? new Date(patient.lastVisit).toLocaleDateString()
          : "N/A";
      }

      // Display patient history timeline
      function displayPatientHistory(patient) {
        const historyContent = document.getElementById("patientHistoryContent");
        historyContent.innerHTML = "";
        if (patient.encounters.length === 0) {
          historyContent.innerHTML = `<div class="text-center py-8 text-gray-500"><div class="text-4xl mb-4">📜</div><p>No past encounters found for this patient.</p></div>`;
          return;
        }

        const sortedEncounters = patient.encounters.sort(
          (a, b) => new Date(b.date) - new Date(a.date)
        );

        historyContent.innerHTML = sortedEncounters
          .map((encounter, index) => {
            const date = new Date(encounter.date).toLocaleDateString();
            const diagnosesHtml = encounter.diagnoses
              .map(
                (diag) => `
            <div class="mt-2 text-sm">
              <span class="font-semibold text-gray-800">${diag.namaste?.code}</span>
              <span class="text-gray-600">- ${diag.namaste?.display}</span>
              <span class="text-gray-400"> (ICD-11: ${diag.icd11?.code})</span>
            </div>
          `
              )
              .join("");

            return `
            <div class="relative pl-6 pb-8 timeline-item">
              ${
                index < sortedEncounters.length - 1
                  ? '<div class="timeline-line"></div>'
                  : ""
              }
              <div class="mb-2">
                <span class="text-sm font-semibold text-gray-700">${date}</span>
              </div>
              ${diagnosesHtml}
            </div>
          `;
          })
          .join("");
      }

      function showAlert(message, type) {
        const existingAlert = document.querySelector(".alert-box");
        if (existingAlert) existingAlert.remove();

        const alertBox = document.createElement("div");
        alertBox.className = `alert-box p-3 border rounded-lg shadow-lg fade-in`;
        const alertColors = {
          success: "bg-green-100 border-green-400 text-green-700",
          warning: "bg-yellow-100 border-yellow-400 text-yellow-700",
          error: "bg-red-100 border-red-400 text-red-700",
          info: "bg-blue-100 border-blue-400 text-blue-700",
        };

        alertBox.className += ` ${alertColors[type]}`;
        alertBox.innerHTML = `<span>${message}</span>`;
        document.body.appendChild(alertBox);

        setTimeout(() => {
          alertBox.classList.remove("fade-in");
          alertBox.classList.add("opacity-0");
          setTimeout(() => alertBox.remove(), 300);
        }, 3000);
      }

      // Initial load and event listeners
      document.addEventListener("DOMContentLoaded", () => {
        // Check for any codes from localStorage and populate session
        const selectedCodesString = localStorage.getItem("selectedCodes");
        if (selectedCodesString) {
          currentSession = JSON.parse(selectedCodesString);
          updateCurrentSession();
          localStorage.removeItem("selectedCodes");
        }
      });

      function showCreatePatientModal() {
        const modal = document.getElementById("newPatientModal");
        modal.classList.remove("hidden");
        modal.querySelector("div").classList.remove("scale-95");
        modal.querySelector("div").classList.add("scale-100");
      }

      // Close the modal and reset the form
      function closeModal() {
        const modal = document.getElementById("newPatientModal");
        modal.querySelector("div").classList.remove("scale-100");
        modal.querySelector("div").classList.add("scale-95");
        setTimeout(() => {
          modal.classList.add("hidden");
          document.getElementById("newPatientForm").reset();
        }, 300);
      }

      // New patient creation function, called from the modal form submission
      async function createNewPatientFromModal(event) {
        event.preventDefault(); // Prevents the form from submitting in the traditional way

        const patientId = document.getElementById("newPatientId").value.trim();
        const patientName = document
          .getElementById("newPatientName")
          .value.trim();
        const patientDob = document.getElementById("newPatientDob").value;
        const patientGender = document.getElementById("newPatientGender").value;

        if (!patientId || !patientName) {
          showAlert("Patient ID and Name are required.", "warning");
          return;
        }

        const payload = {
          patientId: patientId,
          patientName: patientName,
          patientDob: patientDob,
          patientGender: patientGender,
          diagnoses: [],
        };

        try {
          const res = await fetch(
            "http://localhost:5000/api/v1/encounters/upload",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );

          if (!res.ok) {
            if (res.status === 409) {
              showAlert(`Patient ID ${patientId} already exists.`, "error");
            } else {
              throw new Error("Failed to create new patient");
            }
            return;
          }

          const newPatient = await res.json();
          currentPatient = newPatient;
          displayPatientInfo(currentPatient);
          closeModal(); // Close the modal on success

          document
            .getElementById("patientInfoSection")
            .classList.remove("hidden");
          document
            .getElementById("patientHistorySection")
            .classList.remove("hidden");
          showAlert(
            `New patient record for ${newPatient.name} created successfully!`,
            "success"
          );
        } catch (err) {
          showAlert("Error creating new patient: " + err.message, "error");
          console.error("Create new patient error:", err);
        }
      }

      // Listen for the form submission
      document
        .getElementById("newPatientForm")
        .addEventListener("submit", createNewPatientFromModal);

      // Attach the modal opening function to the button
      document
        .querySelector(".px-4.py-2.bg-blue-100")
        .addEventListener("click", showCreatePatientModal);
    </script>

    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'9821e992a39c8ee8',t:'MTc1ODM3NzQ5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
